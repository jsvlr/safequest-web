<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SafeQuest | Emegency Evacuation Adventure</title>
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <!-- Fontawesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap"
      rel="stylesheet"
    />
    <!-- RECAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LdxIt4rAAAAANazk-nZ_-svBdqgDp4DjZlR5pVm"></script>
    <script type="module" src="js/firebase-config.js"></script>

    <link rel="stylesheet" href="css/styles.css" />
    <link
      rel="shortcut icon"
      href="images/SafeQuest-logo.png"
      type="image/x-icon"
    />
  </head>
  <body
    style="
      height: 100vh;
      scroll-behavior: smooth;
      background-image: url('images/header-background.jpg');
      background-repeat: no-repeat;
      background-size: cover;
    "
  >
    <div
      id="app"
      class="container-fluid h-100 d-flex justify-content-center align-items-center"
    >
      <main class="shadow rounded-2 bg-white" style="width: 400px">
        <div
          class="d-flex justify-content-center align-items-center gap-2 p-3 rounded-top-3"
        >
          <div>
            <img
              src="images/SafeQuest-logo.png"
              height="50"
              width="50"
              alt="SafeQuest-logo.png"
            />
          </div>
          <div class="d-flex flex-column gap-0">
            <span class="h1 mb-0">SafeQuest</span>
            <span class="h6 mt-0">Emegency Evacuation Adventure</span>
          </div>
        </div>
        <hr class="hr mt-0" />

        <form
          method="POST"
          class="p-4 needs-validation"
          novalidate
          id="registration-form"
        >
          <div class="mb-3">
            <div class="row gx-md-2 gx-1">
              <div class="col-7">
                <label for="username" class="form-label opacity-75 small"
                  >Username</label
                >
                <div class="input-group">
                  <span
                    class="input-group-text border-end-0 bg-white opacity-75"
                    ><i class="fa-solid fa-user-astronaut"></i
                  ></span>
                  <input
                    type="text"
                    id="username"
                    name="username"
                    class="form-control px-4 py-2 border-start-0 shadow-none rounded-end-2"
                    placeholder="johndoe21"
                    required
                  />
                </div>
              </div>
              <div class="col-5">
                <label for="gender" class="form-label opacity-75 small"
                  >Gender</label
                >
                <div class="input-group">
                  <span
                    class="input-group-text border-end-0 bg-white opacity-75"
                    ><i class="fa-solid fa-mars"></i
                  ></span>
                  <select
                    name="gender"
                    class="form-select shadow-none border-start-0 py-2"
                    id="gender"
                    required
                  >
                    <option value="male" selected>M</option>
                    <option value="female">F</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label opacity-75 small">Email</label>
            <div class="input-group">
              <span class="input-group-text border-end-0 bg-white opacity-75"
                ><i class="fa-solid fa-envelope"></i
              ></span>
              <input
                type="email"
                name="email"
                class="form-control px-4 py-2 border-start-0 shadow-none rounded-end-2"
                id="email"
                placeholder="johndoe@gmail.com"
                required
              />
            </div>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label opacity-75 small"
              >Password</label
            >
            <div class="input-group">
              <span class="input-group-text border-end-0 bg-white opacity-75"
                ><i class="fa-solid fa-lock"></i
              ></span>
              <input
                type="password"
                name="password"
                class="form-control px-4 py-2 border-start-0 border-end-0 shadow-none"
                id="password"
                style="letter-spacing: 2px"
                required
              />
              <span
                class="input-group-text border-start-0 bg-white password-toggle"
                type="button"
                data-toggle-name="password"
                ><i
                  class="fa-regular fa-eye opacity-50 password-toggle-icon"
                ></i
              ></span>
            </div>
            <div class="text-end text-dark-subtle">
              <span
                id="password-helper"
                class="poppin small"
                style="text-transform: lowercase; font-size: 12px"
              ></span>
            </div>
          </div>
          <div class="mb-3">
            <label for="password-confirm" class="form-label opacity-75 small"
              >Password Confirmation</label
            >
            <div class="input-group">
              <span class="input-group-text border-end-0 bg-white opacity-75"
                ><i class="fa-solid fa-lock"></i
              ></span>
              <input
                type="password"
                name="password-confirm"
                class="form-control px-4 py-2 border-start-0 border-end-0 shadow-none"
                id="password-confirm"
                style="letter-spacing: 2px"
                required
              />
              <span
                class="input-group-text border-start-0 bg-white password-toggle"
                type="button"
                data-toggle-name="password-confirm"
                ><i
                  class="fa-regular fa-eye opacity-50 password-toggle-icon"
                ></i
              ></span>
            </div>
          </div>

          <div class="d-flex justify-content-center align-items-center">
            <div
              class="g-recaptcha"
              data-sitekey="6LdxIt4rAAAAANazk-nZ_-svBdqgDp4DjZlR5pVm"
            ></div>
          </div>
          <div class="text-center mt-2">
            <button class="btn btn-primary w-100 py-3" type="submit">
              Register Account
            </button>
          </div>
        </form>
      </main>
    </div>

    <script type="module" src="js/app.js"></script>
    <!-- Bootstrap -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
      integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
      crossorigin="anonymous"
    ></script>
    <!-- SweetAlert v2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      // prevent inspect element
      // document.addEventListener("contextmenu", (e) => e.preventDefault());
      // document.onkeydown = (e) => {
      //   if (
      //     e.keyCode === 123 ||
      //     (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74))
      //   ) {
      //     return false;
      //   }
      // };
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        sendEmailVerification,
        updateProfile,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

      const firebaseConfig_ = {
        apiKey: "AIzaSyDre7rAa9ZpjFsCPy0_yZWRLIS3xgSWIQo",
        authDomain: "safequest-db.firebaseapp.com",
        databaseURL: "https://safequest-db-default-rtdb.firebaseio.com",
        projectId: "safequest-db",
        storageBucket: "safequest-db.firebasestorage.app",
        messagingSenderId: "688619850297",
        appId: "1:688619850297:web:2f13a361ffb5235db69be8",
        measurementId: "G-5NRJHMP13D",
      };

      // Initialize Firebase
      const app_ = initializeApp(firebaseConfig_);
      const auth = getAuth(app_);
      const database = getDatabase(app_);

      const registrationForm = document.getElementById("registration-form");
      const passwordInput = document.getElementById("password");
      const passwordHelper = document.getElementById("password-helper");
      const passwordTogglers = document.querySelectorAll(".password-toggle");
      const passwordIcon = {
        hide: `fa-regular fa-eye opacity-50 password-toggle-icon`,
        show: `fa-regular fa-eye-slash opacity-50 password-toggle-icon`,
      };
      let isPasswordValid = false;

      registrationForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Check form validity
        if (!registrationForm.checkValidity()) {
          e.stopImmediatePropagation();
          registrationForm.classList.add("was-validated");
          return;
        }

        // Check reCAPTCHA
        if (typeof grecaptcha === "undefined") {
          showAlert(
            "error",
            "reCAPTCHA Error",
            "reCAPTCHA not loaded. Please refresh the page."
          );
          return;
        }

        const recaptchaToken = grecaptcha.getResponse();
        if (!recaptchaToken) {
          showAlert(
            "warning",
            "reCAPTCHA Required",
            "Please complete the reCAPTCHA validation."
          );
          return;
        }

        const formData = new FormData(e.target);
        const password = formData.get("password");
        const confirmPassword = formData.get("password-confirm");

        // Validate password
        verifyStrongPassword(password);

        if (!isPasswordValid || password !== confirmPassword) {
          showAlert(
            "warning",
            "Invalid Password",
            "Please check your password requirements and confirmation."
          );
          return;
        }

        // Get form data
        const userData = {
          email: formData.get("email"),
          password: password,
          username: formData.get("username"),
          gender: formData.get("gender"),
        };

        // Register user
        await registerUser(userData);
      });

      async function registerUser(userData) {
        try {
          showLoadingAlert(
            "Registering...",
            "Please wait while we create your account."
          );

          // 1. Create user with Firebase Auth
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            userData.email,
            userData.password
          );

          const user = userCredential.user;

          // 2. Store user profile in Realtime Database
          await set(ref(database, "players/" + user.uid), {
            username: userData.username,
            gender: userData.gender,
            email: userData.email,
            isCurrentPlayer: false,
            level: 1,
            score: 0,
            createdAt: Date.now(),
            updatedAt: Date.now(),
            lastLogin: Date.now(),
          });

          // 3. Send email verification
          await sendEmailVerification(user);

          // 4. Update user profile with display name
          await updateProfile(user, {
            displayName: userData.username,
          });

          // Success
          Swal.fire({
            icon: "success",
            title: "Registration Successful!",
            html: `
        <p>Welcome, ${userData.username}!</p>
        <p>We've sent a verification email to <strong>${userData.email}</strong>.</p>
        <p>Please check your inbox and verify your email address.</p>
      `,
            confirmButtonText: "Got it!",
          });

          // Reset form
          registrationForm.reset();
          registrationForm.classList.remove("was-validated");
        } catch (error) {
          console.error("Registration error:", error);
          handleRegistrationError(error);
        } finally {
          // Reset reCAPTCHA
          if (typeof grecaptcha !== "undefined") {
            grecaptcha.reset();
          }
        }
      }

      function handleRegistrationError(error) {
        let errorMessage = "Registration failed. Please try again.";

        switch (error.code) {
          case "auth/email-already-in-use":
            errorMessage =
              "This email is already registered. Please use a different email or try logging in.";
            break;
          case "auth/invalid-email":
            errorMessage =
              "The email address is not valid. Please check and try again.";
            break;
          case "auth/weak-password":
            errorMessage =
              "The password is too weak. Please choose a stronger password.";
            break;
          case "auth/network-request-failed":
            errorMessage =
              "Network error. Please check your internet connection and try again.";
            break;
          case "auth/too-many-requests":
            errorMessage = "Too many attempts. Please try again later.";
            break;
          case "database/permission-denied":
            errorMessage =
              "Permission denied. Please refresh the page and try again.";
            break;
        }

        Swal.fire({
          icon: "error",
          title: "Registration Failed",
          text: errorMessage,
          confirmButtonText: "Try Again",
        });
      }

      function showLoadingAlert(title, text) {
        Swal.fire({
          title: title,
          text: text,
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
      }

      function showAlert(icon, title, text) {
        Swal.fire({
          icon: icon,
          title: title,
          text: text,
          confirmButtonText: "OK",
        });
      }

      // Your existing password validation function
      function verifyStrongPassword(password) {
        const validChar = 8;
        passwordHelper.textContent = "";
        isPasswordValid = false;

        if (password.length < validChar) {
          passwordHelper.textContent =
            "Password must be at least 8 characters long.";
          return;
        }

        const hasLowerCase = /[a-z]/.test(password);
        if (!hasLowerCase) {
          passwordHelper.textContent =
            "Password must contain at least one lowercase letter.";
          return;
        }

        const hasDigit = /\d/.test(password);
        if (!hasDigit) {
          passwordHelper.textContent =
            "Password must contain at least one digit.";
          return;
        }

        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        if (!hasSpecialChar) {
          passwordHelper.textContent =
            "Password must contain at least one special character.";
          return;
        }

        isPasswordValid = true;
        passwordHelper.textContent = "âœ“ Password is strong";
        passwordHelper.style.color = "green";
      }

      passwordInput.addEventListener("input", (e) => {
        verifyStrongPassword(e.target.value);
      });

      passwordTogglers.forEach((toggle) => {
        toggle.addEventListener("click", (e) => {
          e.preventDefault();
          console.log(toggle);
          let icon = toggle.querySelector(`.password-toggle-icon`);
          let nameAttr = toggle.getAttribute("data-toggle-name");
          let password = document.querySelector(`input[name='${nameAttr}']`);
          icon.classList =
            password.type == "password"
              ? passwordIcon["show"]
              : passwordIcon["hide"];
          password.type = password.type == "password" ? "text" : "password";
        });
      });
    </script>
  </body>
</html>
